# ADR-001: RFC 7807 Error Responses

Дата: 2025-11-03
Статус: Accepted

## Context

- В API поиска рецептов возможны ошибки валидации данных ингредиентов, ошибки поиска и внутренние ошибки сервера.
- Необходимо обеспечить единообразный, безопасный и предсказуемый формат ошибок.
- Особенно важно логирование ошибок поиска рецептов (NFR-10) для анализа и улучшения поиска.

## Decision

- Все ошибки возвращаются в формате **RFC 7807 (application/problem+json)** с обязательными полями:
  - `type`, `title`, `status`, `detail`, `correlation_id`
- В логах сохраняется `correlation_id` для сопоставления клиентских и серверных событий
- Внутренние детали (stack trace, SQL, пути файлов) маскируются
- Добавить централизованный обработчик ошибок (`app/core/error_handler.py`)
- Специальные типы ошибок для поиска рецептов:
  - `recipe-not-found`
  - `invalid-ingredients`
  - `search-timeout`

## Alternatives

- Использовать стандартные исключения FastAPI без унификации формата
- Возвращать произвольные JSON-ответы с ошибками
  _(Минусы - нарушает единообразие и усложняет мониторинг)_

## Consequences

**Плюсы:**

- Единый формат ошибок для всего API
- Безопасная обработка исключений без утечки деталей
- Улучшение отладки через correlation_id
- 100% логирование ошибок поиска (NFR-10)

**Минусы:**

- Добавляется слой абстракции
- Потребуется обновить тесты на ошибки

## Security impact

- Снижение риска R2 (утечка деталей в ошибках) из STRIDE
- Соответствие NFR-02 (защита данных) и NFR-10 (логирование ошибок)
- Упрощение анализа инцидентов через correlation_id

## Rollout plan

1. Создать модуль `app/core/error_handler.py`
2. Определить типы ошибок для рецептов/поиска
3. Добавить тесты в `tests/test_errors.py`
4. Настроить логирование с correlation_id

## Links

- **NFR:** [NFR-02](https://github.com/hse-secdev-2025-fall/course-project-Gervantinno/pull/4), [NFR-10](https://github.com/hse-secdev-2025-fall/course-project-Gervantinno/pull/4)
- **Threat Model:** Поток [F2 /recipes/search] → Риск [R2]
- **Тесты:** `tests/test_errors.py`
- **RISKS.md:** R2 — Утечка информации в ошибках
  - Критерий закрытия: Проверка маскирования деталей в ответах
