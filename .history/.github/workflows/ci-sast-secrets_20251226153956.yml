name: Security - SAST & Secrets

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.py"
      - "security/semgrep/**"
      - "security/.gitleaks.toml"
      - ".github/workflows/ci-sast-secrets.yml"
  pull_request:
    paths:
      - "**/*.py"
      - "security/semgrep/**"
      - "security/.gitleaks.toml"

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast_secrets:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get commit info
        id: commit
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "full_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "Current commit: ${SHORT_SHA} (${GITHUB_SHA})"

      - name: Create evidence directory
        run: |
          mkdir -p EVIDENCE/P10

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Semgrep CI (SARIF) with custom rules
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          echo "Running Semgrep scan for commit ${SHORT_SHA}"
          
          python -m pip install --upgrade pip
          pip install semgrep==1.73.0
          
          # Run semgrep with custom rules and generate SARIF
          semgrep ci \
            --config p/ci \
            --config security/semgrep/rules.yml \
            --sarif \
            --output "EVIDENCE/P10/semgrep-${SHORT_SHA}.sarif" \
            --metrics=off \
            --no-suppress-errors \
            || echo "Semgrep completed with findings"
          
          # Create latest symlink
          ln -sf "semgrep-${SHORT_SHA}.sarif" "EVIDENCE/P10/semgrep-latest.sarif" 2>/dev/null || true

      - name: Gitleaks detect with project config
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          echo "Running Gitleaks scan for commit ${SHORT_SHA}"
          
          # Создаем временный каталог с правами
          mkdir -p /tmp/gitleaks
          chmod 777 /tmp/gitleaks
          
          # Запускаем с правами root для записи
          docker run --rm \
            -u root \
            -v "${{ github.workspace }}":/repo \
            -v "/tmp/gitleaks":/output \
            zricethezav/gitleaks:v8.18.1 \
            detect \
            --no-banner \
            --config="/repo/security/.gitleaks.toml" \
            --source="/repo" \
            --report-format=json \
            --report-path="/output/gitleaks-${SHORT_SHA}.json" \
            || echo "Gitleaks completed with findings"
          
          # Копируем отчет
          cp "/tmp/gitleaks/gitleaks-${SHORT_SHA}.json" "EVIDENCE/P10/gitleaks-${SHORT_SHA}.json" 2>/dev/null || true
          
          # Проверяем что файл создан
          if [ -f "EVIDENCE/P10/gitleaks-${SHORT_SHA}.json" ]; then
            echo "✅ Gitleaks report created: gitleaks-${SHORT_SHA}.json"
            # Create latest symlink
            ln -sf "gitleaks-${SHORT_SHA}.json" "EVIDENCE/P10/gitleaks-latest.json" 2>/dev/null || true
          else
            echo "❌ Gitleaks report NOT created, creating empty file"
            echo "[]" > "EVIDENCE/P10/gitleaks-${SHORT_SHA}.json"
          fi

      - name: Generate detailed SAST summary with analysis
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          SEMG_SARIF="EVIDENCE/P10/semgrep-${SHORT_SHA}.sarif"
          GITL_JSON="EVIDENCE/P10/gitleaks-${SHORT_SHA}.json"
          
          echo "# P10 SAST & Secrets Scan Summary - Commit ${SHORT_SHA}" > "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "**Scan Date:** $(date)" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "**Commit:** ${SHORT_SHA}" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "**Workflow Run:** ${{ github.run_id }}" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          
          # Semgrep analysis
          echo "## Semgrep SAST Results" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          
          if [ -f "$SEMG_SARIF" ] && [ -s "$SEMG_SARIF" ]; then
            # Count findings by severity
            HIGH_COUNT=$(jq -r '.runs[0].results[] | select(.level == "error" or .level == "warning") | .ruleId' "$SEMG_SARIF" 2>/dev/null | wc -l || echo "0")
            MEDIUM_COUNT=$(jq -r '.runs[0].results[] | select(.level == "note") | .ruleId' "$SEMG_SARIF" 2>/dev/null | wc -l || echo "0")
            
            echo "**Findings Count:**" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
            echo "- High/Warning: ${HIGH_COUNT}" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
            echo "- Medium/Info: ${MEDIUM_COUNT}" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
            echo "" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
            
            if [ "$HIGH_COUNT" -gt 0 ] || [ "$MEDIUM_COUNT" -gt 0 ]; then
              echo "**Key Findings:**" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
              jq -r '.runs[0].results[] | select(.level == "error" or .level == "warning") | "### \(.ruleId)\n- **Level:** \(.level)\n- **File:** \(.locations[0].physicalLocation.artifactLocation.uri)\n- **Message:** \(.message.text)\n"' "$SEMG_SARIF" 2>/dev/null | head -5 >> "EVIDENCE/P10/summary-${SHORT_SHA}.md" || echo "No high/medium findings" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
            else
              echo "✅ No high or medium severity findings found." >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
            fi
          else
            echo "✅ No Semgrep findings or report not generated." >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          fi
          
          echo "" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          
          # Gitleaks analysis
          echo "## Gitleaks Secrets Detection" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          
          if [ -f "$GITL_JSON" ] && [ -s "$GITL_JSON" ]; then
            LEAK_COUNT=$(jq 'length' "$GITL_JSON" 2>/dev/null || echo "0")
            
            echo "**Secrets Found:** ${LEAK_COUNT}" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
            echo "" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
            
            if [ "$LEAK_COUNT" -gt 0 ]; then
              echo "**Detected Secrets:**" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
              jq -r '.[] | "### \(.Description)\n- **File:** \(.File)\n- **Rule:** \(.RuleID)\n- **Secret:** \(.Secret | .[0:20])...\n- **Line:** \(.StartLine)\n"' "$GITL_JSON" 2>/dev/null | head -3 >> "EVIDENCE/P10/summary-${SHORT_SHA}.md" || echo "Failed to parse findings" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
            else
              echo "✅ No secrets detected." >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
            fi
          else
            echo "✅ No Gitleaks findings or report not generated." >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          fi
          
          echo "" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          
          # Analysis and Action Plan
          echo "## Security Analysis & Action Plan" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          
          echo "### Critical Secret Types for This Project:" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "1. **JWT Secrets** - Used for authentication tokens" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "2. **Database Credentials** - PostgreSQL connection strings" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "3. **API Keys** - External service integrations" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "4. **Encryption Keys** - For sensitive data at rest" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          
          echo "### How We Handle Secrets:" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "1. **Development**: Use `.env` files (gitignored) with placeholder values" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "2. **CI/CD**: GitHub Actions secrets or Vault" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "3. **Production**: Secret management service (AWS Secrets Manager, etc.)" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "4. **Hardcoded Values**: Only allowed for test/demo markers with clear allowlist" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          
          echo "### SAST Rules Configuration:" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "- **Base Rules**: OWASP Top 10, security best practices" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "- **Custom Rules**: Tailored for FastAPI/Recipe Manager patterns" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "- **Allowlist**: Whitelisted known safe patterns for development" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          echo "" >> "EVIDENCE/P10/summary-${SHORT_SHA}.md"
          
          # Create latest symlink for summary
          ln -sf "summary-${SHORT_SHA}.md" "EVIDENCE/P10/summary-latest.md" 2>/dev/null || true

      - name: Create README with current reports
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          
          echo "# P10 - SAST & Secrets Scan Reports" > "EVIDENCE/P10/README.md"
          echo "" >> "EVIDENCE/P10/README.md"
          echo "## Latest Scan (${SHORT_SHA})" >> "EVIDENCE/P10/README.md"
          echo "- **Semgrep SARIF:** [semgrep-latest.sarif](semgrep-latest.sarif) (from [semgrep-${SHORT_SHA}.sarif](semgrep-${SHORT_SHA}.sarif))" >> "EVIDENCE/P10/README.md"
          echo "- **Gitleaks JSON:** [gitleaks-latest.json](gitleaks-latest.json) (from [gitleaks-${SHORT_SHA}.json](gitleaks-${SHORT_SHA}.json))" >> "EVIDENCE/P10/README.md"
          echo "- **Scan Summary:** [summary-latest.md](summary-latest.md) (from [summary-${SHORT_SHA}.md](summary-${SHORT_SHA}.md))" >> "EVIDENCE/P10/README.md"
          echo "- **Scan Date:** $(date)" >> "EVIDENCE/P10/README.md"
          echo "" >> "EVIDENCE/P10/README.md"
          
          echo "## Available Reports:" >> "EVIDENCE/P10/README.md"
          echo "| File | Description |" >> "EVIDENCE/P10/README.md"
          echo "|------|-------------|" >> "EVIDENCE/P10/README.md"
          
          for file in EVIDENCE/P10/*; do
            filename=$(basename "$file")
            if [[ "$filename" == *.sarif ]]; then
              echo "| [$filename]($filename) | Semgrep SAST report |" >> "EVIDENCE/P10/README.md"
            elif [[ "$filename" == *.json ]]; then
              echo "| [$filename]($filename) | Gitleaks secrets report |" >> "EVIDENCE/P10/README.md"
            elif [[ "$filename" == *.md ]] && [[ "$filename" != "README.md" ]]; then
              echo "| [$filename]($filename) | Scan summary |" >> "EVIDENCE/P10/README.md"
            fi
          done
          
          echo "" >> "EVIDENCE/P10/README.md"
          echo "## How to View Reports" >> "EVIDENCE/P10/README.md"
          echo "1. Click on the links above to view reports in GitHub" >> "EVIDENCE/P10/README.md"
          echo "2. For SARIF files, use GitHub Code Scanning or a SARIF viewer" >> "EVIDENCE/P10/README.md"
          echo "3. JSON reports can be viewed directly or parsed with jq" >> "EVIDENCE/P10/README.md"

      - name: Upload SAST evidence artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p10-sast-reports-${{ steps.commit.outputs.short_sha }}
          path: EVIDENCE/P10/
          retention-days: 30

      - name: Display scan summary and links
        if: always()
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          echo "=== P10 SAST & Secrets Scan Complete ==="
          echo "Commit: ${SHORT_SHA}"
          echo ""
          echo "Generated Reports in EVIDENCE/P10/:"
          echo ""
          ls -la EVIDENCE/P10/ || echo "No reports generated"
          echo ""
          echo "Raw GitHub URLs (copy to PR):"
          echo ""
          echo "### Semgrep SAST:"
          echo "- Latest: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/semgrep-latest.sarif"
          echo "- This commit: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/semgrep-${SHORT_SHA}.sarif"
          echo ""
          echo "### Gitleaks Secrets:"
          echo "- Latest: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/gitleaks-latest.json"
          echo "- This commit: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/gitleaks-${SHORT_SHA}.json"
          echo ""
          echo "### Scan Summary:"
          echo "- Latest: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/summary-latest.md"
          echo "- This commit: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/summary-${SHORT_SHA}.md"

      - name: Commit reports to repository
        if: always() && github.event_name == 'push'
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Проверяем, есть ли изменения для коммита
          CHANGES=false
          
          # Проверяем наличие файлов
          if [ -f "EVIDENCE/P10/semgrep-${SHORT_SHA}.sarif" ]; then
            git add "EVIDENCE/P10/semgrep-${SHORT_SHA}.sarif"
            CHANGES=true
          fi
          
          if [ -f "EVIDENCE/P10/gitleaks-${SHORT_SHA}.json" ]; then
            git add "EVIDENCE/P10/gitleaks-${SHORT_SHA}.json"
            CHANGES=true
          fi
          
          if [ -f "EVIDENCE/P10/summary-${SHORT_SHA}.md" ]; then
            git add "EVIDENCE/P10/summary-${SHORT_SHA}.md"
            CHANGES=true
          fi
          
          # Проверяем README
          if [ -f "EVIDENCE/P10/README.md" ]; then
            git add "EVIDENCE/P10/README.md" || true
            CHANGES=true
          fi
          
          # Обновляем симлинки latest если есть реальные файлы
          if [ -f "EVIDENCE/P10/semgrep-${SHORT_SHA}.sarif" ]; then
            rm -f "EVIDENCE/P10/semgrep-latest.sarif"
            ln -s "semgrep-${SHORT_SHA}.sarif" "EVIDENCE/P10/semgrep-latest.sarif"
            git add "EVIDENCE/P10/semgrep-latest.sarif" || true
            CHANGES=true
          fi
          
          if [ -f "EVIDENCE/P10/gitleaks-${SHORT_SHA}.json" ]; then
            rm -f "EVIDENCE/P10/gitleaks-latest.json"
            ln -s "gitleaks-${SHORT_SHA}.json" "EVIDENCE/P10/gitleaks-latest.json"
            git add "EVIDENCE/P10/gitleaks-latest.json" || true
            CHANGES=true
          fi
          
          if [ -f "EVIDENCE/P10/summary-${SHORT_SHA}.md" ]; then
            rm -f "EVIDENCE/P10/summary-latest.md"
            ln -s "summary-${SHORT_SHA}.md" "EVIDENCE/P10/summary-latest.md"
            git add "EVIDENCE/P10/summary-latest.md" || true
            CHANGES=true
          fi
          
          if [ "$CHANGES" = true ]; then
            # Сначала пулим изменения чтобы быть в актуальном состоянии
            echo "Pulling latest changes..."
            git pull origin ${{ github.ref_name }} --no-rebase --ff-only || echo "Pull failed, continuing..."
            
            # Коммитим изменения
            git commit -m "P10: SAST & Secrets scan report for commit ${SHORT_SHA} [skip ci]

            Generated files:
            - semgrep-${SHORT_SHA}.sarif (SAST report)
            - gitleaks-${SHORT_SHA}.json (secrets scan)
            - summary-${SHORT_SHA}.md (analysis)

            Latest symlinks updated."
            
            # Пушим изменения
            echo "Pushing changes..."
            git push origin ${{ github.ref_name }}
            
            echo "✅ Reports committed and pushed successfully"
          else
            echo "⚠️ No changes to commit"
          fi