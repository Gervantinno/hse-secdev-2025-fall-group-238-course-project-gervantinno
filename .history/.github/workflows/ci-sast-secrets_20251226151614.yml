name: Security - SAST & Secrets

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.py"
      - "security/semgrep/**"
      - "security/.gitleaks.toml"
      - ".github/workflows/ci-sast-secrets.yml"
  pull_request:
    paths:
      - "**/*.py"
      - "security/semgrep/**"
      - "security/.gitleaks.toml"

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast_secrets:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get commit info
        id: commit
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "full_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "Current commit: ${SHORT_SHA} (${GITHUB_SHA})"

      - name: Create evidence directories
        run: |
          mkdir -p EVIDENCE/P10/latest
          mkdir -p "EVIDENCE/P10/commits/${{ steps.commit.outputs.short_sha }}"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Semgrep CI (SARIF) with custom rules
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          echo "Running Semgrep scan for commit ${SHORT_SHA}"

          python -m pip install --upgrade pip
          pip install semgrep==1.73.0

          # Run semgrep with custom rules and generate SARIF
          semgrep ci \
            --config p/ci \
            --config security/semgrep/rules.yml \
            --sarif \
            --output "EVIDENCE/P10/commits/${SHORT_SHA}/semgrep.sarif" \
            --metrics=off \
            --no-suppress-errors \
            || echo "Semgrep completed with findings"

          # Copy to latest
          cp "EVIDENCE/P10/commits/${SHORT_SHA}/semgrep.sarif" "EVIDENCE/P10/latest/semgrep.sarif" 2>/dev/null || true

          # Create symlinks
          ln -sf "commits/${SHORT_SHA}/semgrep.sarif" "EVIDENCE/P10/semgrep.sarif" 2>/dev/null || true

      - name: Gitleaks detect with project config
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          echo "Running Gitleaks scan for commit ${SHORT_SHA}"

          docker run --rm \
            -v "${{ github.workspace }}":/repo \
            zricethezav/gitleaks:v8.18.1 \
            detect \
            --no-banner \
            --config="/repo/security/.gitleaks.toml" \
            --source="/repo" \
            --report-format=json \
            --report-path="/repo/EVIDENCE/P10/commits/${SHORT_SHA}/gitleaks.json" \
            || echo "Gitleaks completed with findings"

          # Copy to latest
          cp "EVIDENCE/P10/commits/${SHORT_SHA}/gitleaks.json" "EVIDENCE/P10/latest/gitleaks.json" 2>/dev/null || true

          # Create symlinks
          ln -sf "commits/${SHORT_SHA}/gitleaks.json" "EVIDENCE/P10/gitleaks.json" 2>/dev/null || true

      - name: Generate detailed SAST summary with analysis
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          SEMG_SARIF="EVIDENCE/P10/commits/${SHORT_SHA}/semgrep.sarif"
          GITL_JSON="EVIDENCE/P10/commits/${SHORT_SHA}/gitleaks.json"

          echo "# P10 SAST & Secrets Scan Summary - Commit ${SHORT_SHA}" > "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "**Scan Date:** $(date)" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "**Commit:** ${SHORT_SHA}" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "**Workflow Run:** ${{ github.run_id }}" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"

          # Semgrep analysis
          echo "## Semgrep SAST Results" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"

          if [ -f "$SEMG_SARIF" ] && [ -s "$SEMG_SARIF" ]; then
            # Count findings by severity
            HIGH_COUNT=$(jq -r '.runs[0].results[] | select(.level == "error" or .level == "warning") | .ruleId' "$SEMG_SARIF" 2>/dev/null | wc -l || echo "0")
            MEDIUM_COUNT=$(jq -r '.runs[0].results[] | select(.level == "note") | .ruleId' "$SEMG_SARIF" 2>/dev/null | wc -l || echo "0")

            echo "**Findings Count:**" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
            echo "- High/Warning: ${HIGH_COUNT}" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
            echo "- Medium/Info: ${MEDIUM_COUNT}" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
            echo "" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"

            if [ "$HIGH_COUNT" -gt 0 ] || [ "$MEDIUM_COUNT" -gt 0 ]; then
              echo "**Key Findings:**" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
              jq -r '.runs[0].results[] | select(.level == "error" or .level == "warning") | "### \(.ruleId)\n- **Level:** \(.level)\n- **File:** \(.locations[0].physicalLocation.artifactLocation.uri)\n- **Message:** \(.message.text)\n"' "$SEMG_SARIF" 2>/dev/null | head -5 >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md" || echo "No high/medium findings" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
            else
              echo "‚úÖ No high or medium severity findings found." >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
            fi
          else
            echo "‚úÖ No Semgrep findings or report not generated." >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          fi

          echo "" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"

          # Gitleaks analysis
          echo "## Gitleaks Secrets Detection" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"

          if [ -f "$GITL_JSON" ] && [ -s "$GITL_JSON" ]; then
            LEAK_COUNT=$(jq 'length' "$GITL_JSON" 2>/dev/null || echo "0")

            echo "**Secrets Found:** ${LEAK_COUNT}" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
            echo "" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"

            if [ "$LEAK_COUNT" -gt 0 ]; then
              echo "**Detected Secrets:**" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
              jq -r '.[] | "### \(.Description)\n- **File:** \(.File)\n- **Rule:** \(.RuleID)\n- **Secret:** \(.Secret | .[0:20])...\n- **Line:** \(.StartLine)\n"' "$GITL_JSON" 2>/dev/null | head -3 >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md" || echo "Failed to parse findings" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
            else
              echo "‚úÖ No secrets detected." >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
            fi
          else
            echo "‚úÖ No Gitleaks findings or report not generated." >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          fi

          echo "" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"

          # Analysis and Action Plan
          echo "## Security Analysis & Action Plan" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"

          echo "### Critical Secret Types for This Project:" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "1. **JWT Secrets** - Used for authentication tokens" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "2. **Database Credentials** - PostgreSQL connection strings" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "3. **API Keys** - External service integrations" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "4. **Encryption Keys** - For sensitive data at rest" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"

          echo "### How We Handle Secrets:" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "1. **Development**: Use `.env` files (gitignored) with placeholder values" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "2. **CI/CD**: GitHub Actions secrets or Vault" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "3. **Production**: Secret management service (AWS Secrets Manager, etc.)" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "4. **Hardcoded Values**: Only allowed for test/demo markers with clear allowlist" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"

          echo "### SAST Rules Configuration:" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "- **Base Rules**: OWASP Top 10, security best practices" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "- **Custom Rules**: Tailored for FastAPI/Recipe Manager patterns" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "- **Allowlist**: Whitelisted known safe patterns for development" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"

          # –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ PR
          echo "## üìã Copy These Links to PR Description:" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "### Latest Reports:" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "- [Semgrep SARIF (latest)](https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/latest/semgrep.sarif)" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "- [Gitleaks JSON (latest)](https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/latest/gitleaks.json)" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "### This Commit:" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "- [Semgrep SARIF (${SHORT_SHA})](https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/commits/${SHORT_SHA}/semgrep.sarif)" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "- [Gitleaks JSON (${SHORT_SHA})](https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/commits/${SHORT_SHA}/gitleaks.json)" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"
          echo "- [Scan Summary](https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/commits/${SHORT_SHA}/summary.md)" >> "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md"

          # Create main README
          echo "# P10 - SAST & Secrets Scan Reports" > "EVIDENCE/P10/README.md"
          echo "" >> "EVIDENCE/P10/README.md"
          echo "## Latest Scan" >> "EVIDENCE/P10/README.md"
          echo "- **Semgrep Report:** [latest/semgrep.sarif](latest/semgrep.sarif)" >> "EVIDENCE/P10/README.md"
          echo "- **Gitleaks Report:** [latest/gitleaks.json](latest/gitleaks.json)" >> "EVIDENCE/P10/README.md"
          echo "- **Scan Summary:** [commits/${SHORT_SHA}/summary.md](commits/${SHORT_SHA}/summary.md)" >> "EVIDENCE/P10/README.md"
          echo "- **Commit:** ${SHORT_SHA}" >> "EVIDENCE/P10/README.md"
          echo "- **Date:** $(date)" >> "EVIDENCE/P10/README.md"
          echo "" >> "EVIDENCE/P10/README.md"

          echo "## Historical Scans" >> "EVIDENCE/P10/README.md"
          if ls -d EVIDENCE/P10/commits/*/ 2>/dev/null; then
            ls -d EVIDENCE/P10/commits/*/ 2>/dev/null | sort -r | while read dir; do
              commit=$(basename "$dir")
              date_str=$(stat -c %y "$dir/summary.md" 2>/dev/null | cut -d' ' -f1 || echo 'unknown')
              echo "- [${commit}](commits/${commit}/) - ${date_str}" >> "EVIDENCE/P10/README.md"
            done
          else
            echo "No historical scans yet." >> "EVIDENCE/P10/README.md"
          fi

          echo "" >> "EVIDENCE/P10/README.md"
          echo "## How to View Reports" >> "EVIDENCE/P10/README.md"
          echo "1. **Semgrep SARIF**: Use GitHub Code Scanning or SARIF viewer" >> "EVIDENCE/P10/README.md"
          echo "2. **Gitleaks JSON**: Inspect JSON or use Gitleaks CLI" >> "EVIDENCE/P10/README.md"
          echo "3. **Raw GitHub URLs**: Click on links above for direct access" >> "EVIDENCE/P10/README.md"

      - name: Upload SAST evidence artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p10-sast-reports-${{ steps.commit.outputs.short_sha }}
          path: EVIDENCE/P10/
          retention-days: 30

      - name: Display scan summary and PR instructions
        if: always()
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          echo "=== P10 SAST & Secrets Scan Complete ==="
          echo "Commit: ${SHORT_SHA}"
          echo ""
          echo "üìÅ Reports Structure:"
          echo "  - EVIDENCE/P10/latest/ (always latest)"
          echo "  - EVIDENCE/P10/commits/${SHORT_SHA}/ (versioned)"
          echo ""
          echo "üîó Copy these links to your PR description:"
          echo ""
          echo "### Latest Reports:"
          echo "- [Semgrep SARIF (latest)](https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/latest/semgrep.sarif)"
          echo "- [Gitleaks JSON (latest)](https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/latest/gitleaks.json)"
          echo ""
          echo "### This Commit (${SHORT_SHA}):"
          echo "- [Semgrep SARIF (${SHORT_SHA})](https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/commits/${SHORT_SHA}/semgrep.sarif)"
          echo "- [Gitleaks JSON (${SHORT_SHA})](https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/commits/${SHORT_SHA}/gitleaks.json)"
          echo "- [Scan Summary](https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/commits/${SHORT_SHA}/summary.md)"
          echo ""
          echo "üìã Summary of findings:"
          if [ -f "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md" ]; then
            cat "EVIDENCE/P10/commits/${SHORT_SHA}/summary.md" | grep -A5 "## Semgrep SAST Results\|## Gitleaks Secrets Detection" | head -20
          fi

      - name: Commit reports to repository
        if: always() && github.event_name == 'push'
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add EVIDENCE/P10/ || true

          if ! git diff --cached --quiet; then
            git commit -m "P10: SAST & Secrets scan report for commit ${SHORT_SHA} [skip ci]

          Semgrep & Gitleaks scan results:
            - Commit: ${SHORT_SHA}
            - Semgrep: EVIDENCE/P10/commits/${SHORT_SHA}/semgrep.sarif
            - Gitleaks: EVIDENCE/P10/commits/${SHORT_SHA}/gitleaks.json
            - Latest: EVIDENCE/P10/latest/"

                if [ "${{ github.event_name }}" != "pull_request" ]; then
                git pull --rebase
                git push
                fi
                else
                echo "No changes to commit"
                fi
