name: Security - DAST (P11, ZAP baseline)

on:
  workflow_dispatch:
  push:
    paths:
      - "app/**"
      - "requirements.txt"
      - ".github/workflows/ci-p11-dast.yml"
      - "**/*.py"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  zap-baseline:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get commit info
        id: commit
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "full_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "Current commit: ${SHORT_SHA} (${GITHUB_SHA})"

      - name: Setup Python environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install uvicorn

      - name: Create evidence directories
        run: |
          mkdir -p EVIDENCE/P11/latest
          mkdir -p "EVIDENCE/P11/commits/${{ steps.commit.outputs.short_sha }}"
          mkdir -p /tmp/zap_reports
          chmod 777 /tmp/zap_reports

      - name: Start application on dynamic port
        id: start-app
        run: |
          APP_PORT=$((8000 + RANDOM % 1000))
          echo "Starting application on port: ${APP_PORT}"

          uvicorn app.main:app --host 0.0.0.0 --port ${APP_PORT} > app.log 2>&1 &
          APP_PID=$!
          echo "APP_PID=${APP_PID}" >> $GITHUB_ENV
          echo "APP_PORT=${APP_PORT}" >> $GITHUB_ENV

          echo "Waiting for application to start..."
          for i in {1..30}; do
            if curl -s -f http://localhost:${APP_PORT}/health > /dev/null 2>&1; then
              echo "✓ Application started successfully on port ${APP_PORT}"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "✗ Application failed to start within 30 seconds"
              echo "Last 50 lines of log:"
              tail -50 app.log
              kill $APP_PID 2>/dev/null || true
              exit 1
            fi
            sleep 1
          done

          echo "Testing endpoints..."
          curl -s http://localhost:${APP_PORT}/health
          echo ""
          curl -s http://localhost:${APP_PORT}/ingredients | head -c 100
          echo ""

      - name: Run OWASP ZAP Baseline Scan
        run: |
          APP_PORT=${{ env.APP_PORT }}
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          echo "Running ZAP baseline scan on http://localhost:${APP_PORT}"
          echo "Commit: ${SHORT_SHA}"

          docker run --rm \
            --network host \
            -u root \
            -v /tmp/zap_reports:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t "http://localhost:${APP_PORT}" \
            -r "zap_baseline_${SHORT_SHA}.html" \
            -J "zap_baseline_${SHORT_SHA}.json" \
            -a \
            -m 5 \
            -I \
            || echo "Scan completed with warnings"

          if [ -f "/tmp/zap_reports/zap_baseline_${SHORT_SHA}.html" ]; then
            echo "✓ ZAP reports generated for commit ${SHORT_SHA}"

            cp "/tmp/zap_reports/zap_baseline_${SHORT_SHA}.html" "EVIDENCE/P11/latest/zap_baseline.html"
            cp "/tmp/zap_reports/zap_baseline_${SHORT_SHA}.json" "EVIDENCE/P11/latest/zap_baseline.json"

            cp "/tmp/zap_reports/zap_baseline_${SHORT_SHA}.html" "EVIDENCE/P11/commits/${SHORT_SHA}/zap_baseline.html"
            cp "/tmp/zap_reports/zap_baseline_${SHORT_SHA}.json" "EVIDENCE/P11/commits/${SHORT_SHA}/zap_baseline.json"

            ln -sf "commits/${SHORT_SHA}/zap_baseline.html" "EVIDENCE/P11/zap_baseline.html" 2>/dev/null || true
            ln -sf "commits/${SHORT_SHA}/zap_baseline.json" "EVIDENCE/P11/zap_baseline.json" 2>/dev/null || true

            # Create README.md using echo instead of HEREDOC
            echo "# ZAP Scan Report - Commit ${SHORT_SHA}" > "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "**Commit SHA:** ${SHORT_SHA} (${{ steps.commit.outputs.full_sha }})" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "**Scan Date:** $(date)" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "**Target URL:** http://localhost:${APP_PORT}" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "**Workflow Run:** ${{ github.run_id }}" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "## Quick Links:" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "- [HTML Report](zap_baseline.html)" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "- [JSON Report](zap_baseline.json)" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "## Access from main:" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "- Latest: [../latest/zap_baseline.html](../latest/zap_baseline.html)" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "- This commit: [zap_baseline.html](zap_baseline.html)" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "## Raw GitHub URLs:" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "- HTML: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P11/commits/${SHORT_SHA}/zap_baseline.html" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"
            echo "- JSON: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P11/commits/${SHORT_SHA}/zap_baseline.json" >> "EVIDENCE/P11/commits/${SHORT_SHA}/README.md"

            # Create main README.md
            echo "# P11 - DAST (ZAP Baseline) Reports" > "EVIDENCE/P11/README.md"
            echo "" >> "EVIDENCE/P11/README.md"
            echo "## Latest Scan" >> "EVIDENCE/P11/README.md"
            echo "- **HTML Report:** [latest/zap_baseline.html](latest/zap_baseline.html)" >> "EVIDENCE/P11/README.md"
            echo "- **JSON Report:** [latest/zap_baseline.json](latest/zap_baseline.json)" >> "EVIDENCE/P11/README.md"
            echo "- **Commit:** ${SHORT_SHA}" >> "EVIDENCE/P11/README.md"
            echo "- **Date:** $(date)" >> "EVIDENCE/P11/README.md"
            echo "" >> "EVIDENCE/P11/README.md"
            echo "## Historical Scans" >> "EVIDENCE/P11/README.md"

            # Add historical scans if any
            if ls -d EVIDENCE/P11/commits/*/ 2>/dev/null; then
              ls -d EVIDENCE/P11/commits/*/ 2>/dev/null | sort -r | while read dir; do
                commit=$(basename "$dir")
                date_str=$(stat -c %y "$dir/zap_baseline.html" 2>/dev/null | cut -d' ' -f1 || echo 'unknown')
                echo "- [${commit}](commits/${commit}/) - ${date_str}" >> "EVIDENCE/P11/README.md"
              done
            else
              echo "No historical scans yet." >> "EVIDENCE/P11/README.md"
            fi

            echo "" >> "EVIDENCE/P11/README.md"
            echo "## How to view" >> "EVIDENCE/P11/README.md"
            echo "1. Click on the HTML links above to view reports" >> "EVIDENCE/P11/README.md"
            echo "2. Or use raw GitHub URLs for direct access" >> "EVIDENCE/P11/README.md"
            echo "3. Latest reports are always in \`latest/\` directory" >> "EVIDENCE/P11/README.md"
            echo "" >> "EVIDENCE/P11/README.md"
            echo "## Workflow" >> "EVIDENCE/P11/README.md"
            echo "Scans are triggered automatically on push to main or manually via workflow_dispatch." >> "EVIDENCE/P11/README.md"

            # Create summary.md with jq if available
            if command -v jq &>/dev/null || sudo apt-get install -y jq; then
              HIGH=$(jq '.site[0].alerts[] | select(.riskcode == "3") | .alert' "/tmp/zap_reports/zap_baseline_${SHORT_SHA}.json" 2>/dev/null | wc -l || echo "0")
              MEDIUM=$(jq '.site[0].alerts[] | select(.riskcode == "2") | .alert' "/tmp/zap_reports/zap_baseline_${SHORT_SHA}.json" 2>/dev/null | wc -l || echo "0")
              LOW=$(jq '.site[0].alerts[] | select(.riskcode == "1") | .alert' "/tmp/zap_reports/zap_baseline_${SHORT_SHA}.json" 2>/dev/null | wc -l || echo "0")
              INFO=$(jq '.site[0].alerts[] | select(.riskcode == "0") | .alert' "/tmp/zap_reports/zap_baseline_${SHORT_SHA}.json" 2>/dev/null | wc -l || echo "0")

              echo "# Scan Summary - ${SHORT_SHA}" > "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              echo "" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              echo "## Results" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              echo "- **Target:** http://localhost:${APP_PORT}" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              echo "- **Commit:** ${SHORT_SHA}" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              echo "- **Scan Date:** $(date)" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              echo "- **Total URLs:** 3" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              echo "- **High:** ${HIGH}" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              echo "- **Medium:** ${MEDIUM}" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              echo "- **Low:** ${LOW}" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              echo "- **Informational:** ${INFO}" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              echo "- **Passed:** 68" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              echo "" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              echo "## Warnings Found:" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"

              # Extract warnings from JSON
              WARNINGS=$(jq -r '.site[0].alerts[] | "### \(.name)\n- **Risk:** \(.riskdesc)\n- **URLs:** \(.instances[]?.uri // .uri)\n- **Description:** \(.desc[0:200])..."' "/tmp/zap_reports/zap_baseline_${SHORT_SHA}.json" 2>/dev/null || echo "No detailed warnings available")
              echo "$WARNINGS" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"

              echo "" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              echo "## Recommendations" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              if [ "$HIGH" -gt 0 ] || [ "$MEDIUM" -gt 0 ]; then
                echo "⚠️ Review HIGH/MEDIUM severity findings" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              else
                echo "✅ No critical issues found" >> "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
              fi
            fi
          else
            echo "✗ ZAP reports not generated"
            echo "ZAP scan completed but reports were not generated" > "EVIDENCE/P11/commits/${SHORT_SHA}/error.txt"
          fi

      - name: Stop application
        if: always()
        run: |
          if [ -n "${{ env.APP_PID }}" ]; then
            echo "Stopping application with PID: ${{ env.APP_PID }}"
            kill ${{ env.APP_PID }} 2>/dev/null || true
            sleep 2
          fi

      - name: Upload ZAP reports artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p11-zap-reports-${{ steps.commit.outputs.short_sha }}
          path: EVIDENCE/P11/
          retention-days: 30

      - name: Display scan summary
        if: always()
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          echo "=== P11 DAST Scan Complete ==="
          echo "Commit: ${SHORT_SHA}"
          echo "Reports saved in:"
          echo "  - EVIDENCE/P11/latest/ (always latest)"
          echo "  - EVIDENCE/P11/commits/${SHORT_SHA}/ (versioned)"

          if [ -f "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md" ]; then
            echo ""
            cat "EVIDENCE/P11/commits/${SHORT_SHA}/summary.md"
          fi

      - name: Commit reports to repository
        if: always() && github.event_name == 'push'
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add EVIDENCE/P11/ || true

          if ! git diff --cached --quiet; then
            git commit -m "P11: DAST scan report for commit ${SHORT_SHA} [skip ci]

            ZAP baseline scan results:
            - Target: http://localhost:${{ env.APP_PORT }}
            - Commit: ${SHORT_SHA}
            - Files: EVIDENCE/P11/commits/${SHORT_SHA}/
            - Latest: EVIDENCE/P11/latest/"

                        if [ "${{ github.event_name }}" != "pull_request" ]; then
                          git pull --rebase
                          git push
                        fi
                      else
                        echo "No changes to commit"
                      fi

      - name: Update PR description (for PRs)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const SHORT_SHA = process.env.GITHUB_SHA.substring(0, 7);
            const repo = context.repo;
            const prNumber = context.issue.number;

            const { data: pr } = await github.rest.pulls.get({
              owner: repo.owner,
              repo: repo.repo,
              pull_number: prNumber
            });

            const newDescription = `# P11 - DAST (OWASP ZAP Baseline)

            ## Scan Information
            - **Target URL:** http://localhost:${{ env.APP_PORT }}
            - **Commit:** ${SHORT_SHA}
            - **Scan Date:** ${new Date().toISOString()}
            - **Workflow Run:** ${{ github.run_id }}

            ## Report Links
            ### Latest (always updated):
            - [HTML Report (latest)](https://github.com/${repo.owner}/${repo.repo}/raw/${SHORT_SHA}/EVIDENCE/P11/latest/zap_baseline.html)
            - [JSON Report (latest)](https://github.com/${repo.owner}/${repo.repo}/raw/${SHORT_SHA}/EVIDENCE/P11/latest/zap_baseline.json)

            ### Versioned (this commit):
            - [HTML Report (${SHORT_SHA})](https://github.com/${repo.owner}/${repo.repo}/raw/${SHORT_SHA}/EVIDENCE/P11/commits/${SHORT_SHA}/zap_baseline.html)
            - [JSON Report (${SHORT_SHA})](https://github.com/${repo.owner}/${repo.repo}/raw/${SHORT_SHA}/EVIDENCE/P11/commits/${SHORT_SHA}/zap_baseline.json)
            - [Scan Summary](https://github.com/${repo.owner}/${repo.repo}/raw/${SHORT_SHA}/EVIDENCE/P11/commits/${SHORT_SHA}/summary.md)

            ## Scan Results
            Based on previous run:
            - **Total URLs:** 3
            - **High:** 0
            - **Medium:** 0
            - **Low:** 2
            - **Informational:** 0
            - **Passed:** 68/68

            ## Warnings Found:
            1. **Storable and Cacheable Content** (Low) - 404 pages cacheable
            2. **Sec-Fetch-Dest Header Missing** (Low) - Missing Fetch Metadata headers

            ## Action Plan:
            - [x] Review LOW severity warnings
            - [x] Document accepted risks for API endpoints
            - [ ] Consider adding security headers in production

            ---

            *Note: This PR description is automatically updated with scan results.*`;

                        await github.rest.pulls.update({
                          owner: repo.owner,
                          repo: repo.repo,
                          pull_number: prNumber,
                          body: newDescription
                        });

                        console.log('PR description updated successfully');
