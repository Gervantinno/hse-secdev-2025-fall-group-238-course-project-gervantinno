name: Security - DAST (P11, ZAP baseline)

on:
  workflow_dispatch:
  push:
    paths:
      - "app/**"
      - "requirements.txt"
      - ".github/workflows/ci-p11-dast.yml"
      - "**/*.py"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  zap-baseline:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get commit info
        id: commit
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "full_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "Current commit: ${SHORT_SHA} (${GITHUB_SHA})"

      - name: Clean old evidence directory
        run: |
          # Полностью очищаем папку EVIDENCE/P11 перед началом
          rm -rf EVIDENCE/P11
          mkdir -p EVIDENCE/P11

      - name: Setup Python environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install uvicorn

      - name: Create temporary directory for ZAP
        run: |
          mkdir -p /tmp/zap_reports
          chmod 777 /tmp/zap_reports

      - name: Start application on dynamic port
        id: start-app
        run: |
          APP_PORT=$((8000 + RANDOM % 1000))
          echo "Starting application on port: ${APP_PORT}"

          uvicorn app.main:app --host 0.0.0.0 --port ${APP_PORT} > app.log 2>&1 &
          APP_PID=$!
          echo "APP_PID=${APP_PID}" >> $GITHUB_ENV
          echo "APP_PORT=${APP_PORT}" >> $GITHUB_ENV

          echo "Waiting for application to start..."
          for i in {1..30}; do
            if curl -s -f http://localhost:${APP_PORT}/health > /dev/null 2>&1; then
              echo "✓ Application started successfully on port ${APP_PORT}"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "✗ Application failed to start within 30 seconds"
              echo "Last 50 lines of log:"
              tail -50 app.log
              kill $APP_PID 2>/dev/null || true
              exit 1
            fi
            sleep 1
          done

          echo "Testing endpoints..."
          curl -s http://localhost:${APP_PORT}/health
          echo ""
          curl -s http://localhost:${APP_PORT}/ingredients | head -c 100
          echo ""

      - name: Run OWASP ZAP Baseline Scan
        run: |
          APP_PORT=${{ env.APP_PORT }}
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          echo "Running ZAP baseline scan on http://localhost:${APP_PORT}"
          echo "Commit: ${SHORT_SHA}"

          docker run --rm \
            --network host \
            -u root \
            -v /tmp/zap_reports:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t "http://localhost:${APP_PORT}" \
            -r "zap_baseline_${SHORT_SHA}.html" \
            -J "zap_baseline_${SHORT_SHA}.json" \
            -a \
            -m 5 \
            -I \
            || echo "Scan completed with warnings"

          if [ -f "/tmp/zap_reports/zap_baseline_${SHORT_SHA}.html" ]; then
            echo "✓ ZAP reports generated for commit ${SHORT_SHA}"

            # Копируем отчеты с кодом коммита
            cp "/tmp/zap_reports/zap_baseline_${SHORT_SHA}.html" "EVIDENCE/P11/zap_baseline_${SHORT_SHA}.html"
            cp "/tmp/zap_reports/zap_baseline_${SHORT_SHA}.json" "EVIDENCE/P11/zap_baseline_${SHORT_SHA}.json"
          else
            echo "✗ ZAP reports not generated"
            echo "{}" > "EVIDENCE/P11/zap_baseline_${SHORT_SHA}.json"
            echo "<html><body>Report generation failed</body></html>" > "EVIDENCE/P11/zap_baseline_${SHORT_SHA}.html"
          fi

      - name: Stop application
        if: always()
        run: |
          if [ -n "${{ env.APP_PID }}" ]; then
            echo "Stopping application with PID: ${{ env.APP_PID }}"
            kill ${{ env.APP_PID }} 2>/dev/null || true
            sleep 2
          fi

      - name: Upload ZAP reports artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p11-zap-reports-${{ steps.commit.outputs.short_sha }}
          path: |
            EVIDENCE/P11/zap_baseline_${{ steps.commit.outputs.short_sha }}.html
            EVIDENCE/P11/zap_baseline_${{ steps.commit.outputs.short_sha }}.json
          retention-days: 30

      - name: Display scan summary
        if: always()
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          echo "=== P11 DAST Scan Complete ==="
          echo "Commit: ${SHORT_SHA}"
          echo ""
          echo "Generated Reports in EVIDENCE/P11/:"
          echo ""
          ls -la EVIDENCE/P11/ || echo "No reports generated"
          echo ""
          echo "Raw GitHub URLs (copy to PR):"
          echo ""
          echo "### ZAP Reports:"
          echo "- HTML: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P11/zap_baseline_${SHORT_SHA}.html"
          echo "- JSON: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P11/zap_baseline_${SHORT_SHA}.json"