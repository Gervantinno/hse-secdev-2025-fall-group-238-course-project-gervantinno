name: Security - SAST & Secrets

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.py"
      - "security/semgrep/**"
      - "security/.gitleaks.toml"
      - ".github/workflows/ci-sast-secrets.yml"
  pull_request:
    paths:
      - "**/*.py"
      - "security/semgrep/**"
      - "security/.gitleaks.toml"

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast_secrets:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get commit info
        id: commit
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "full_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "Current commit: ${SHORT_SHA} (${GITHUB_SHA})"

      - name: Clean old evidence directory
        run: |
          # Полностью очищаем папку EVIDENCE/P10 перед началом
          rm -rf EVIDENCE/P10
          mkdir -p EVIDENCE/P10

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Semgrep CI (SARIF) with custom rules
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          echo "Running Semgrep scan for commit ${SHORT_SHA}"
          
          python -m pip install --upgrade pip
          pip install semgrep==1.73.0
          
          # Run semgrep with custom rules and generate SARIF
          semgrep ci \
            --config p/ci \
            --config security/semgrep/rules.yml \
            --sarif \
            --output "EVIDENCE/P10/semgrep_${SHORT_SHA}.sarif" \
            --metrics=off \
            --no-suppress-errors \
            || echo "Semgrep completed with findings"
          
          # Create latest symlink
          ln -sf "semgrep_${SHORT_SHA}.sarif" "EVIDENCE/P10/semgrep_latest.sarif"

      - name: Gitleaks detect with project config
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          echo "Running Gitleaks scan for commit ${SHORT_SHA}"
          
          # Создаем временный каталог с правами
          mkdir -p /tmp/gitleaks
          chmod 777 /tmp/gitleaks
          
          # Запускаем с правами root для записи
          docker run --rm \
            -u root \
            -v "${{ github.workspace }}":/repo \
            -v "/tmp/gitleaks":/output \
            zricethezav/gitleaks:v8.18.1 \
            detect \
            --no-banner \
            --config="/repo/security/.gitleaks.toml" \
            --source="/repo" \
            --report-format=json \
            --report-path="/output/gitleaks_${SHORT_SHA}.json" \
            || echo "Gitleaks completed with findings"
          
          # Копируем отчет
          cp "/tmp/gitleaks/gitleaks_${SHORT_SHA}.json" "EVIDENCE/P10/gitleaks_${SHORT_SHA}.json" 2>/dev/null || true
          
          # Проверяем что файл создан
          if [ -f "EVIDENCE/P10/gitleaks_${SHORT_SHA}.json" ]; then
            echo "✅ Gitleaks report created: gitleaks_${SHORT_SHA}.json"
            # Create latest symlink
            ln -sf "gitleaks_${SHORT_SHA}.json" "EVIDENCE/P10/gitleaks_latest.json"
          else
            echo "❌ Gitleaks report NOT created, creating empty file"
            echo "[]" > "EVIDENCE/P10/gitleaks_${SHORT_SHA}.json"
          fi

      - name: Generate detailed SAST summary with analysis
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          SEMG_SARIF="EVIDENCE/P10/semgrep_${SHORT_SHA}.sarif"
          GITL_JSON="EVIDENCE/P10/gitleaks_${SHORT_SHA}.json"
          
          echo "# P10 SAST & Secrets Scan Summary - Commit ${SHORT_SHA}" > "EVIDENCE/P10/summary_${SHORT_SHA}.md"
          echo "" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
          echo "**Scan Date:** $(date)" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
          echo "**Commit:** ${SHORT_SHA}" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
          echo "**Workflow Run:** ${{ github.run_id }}" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
          echo "" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
          
          # Semgrep analysis
          echo "## Semgrep SAST Results" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
          echo "" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
          
          if [ -f "$SEMG_SARIF" ] && [ -s "$SEMG_SARIF" ]; then
            # Считаем ВСЕ findings
            TOTAL_FINDINGS=$(jq -r '.runs[0].results | length' "$SEMG_SARIF" 2>/dev/null || echo "0")
            
            # Считаем по severity (используем level из результата ИЛИ из defaultConfiguration правила)
            WARNING_COUNT=$(jq -r '[.runs[0].results[] | .level // .properties.metadata.severity // "note"] | map(select(. == "warning" or . == "error")) | length' "$SEMG_SARIF" 2>/dev/null || echo "0")
            INFO_COUNT=$(jq -r '[.runs[0].results[] | .level // .properties.metadata.severity // "note"] | map(select(. == "note" or . == "info")) | length' "$SEMG_SARIF" 2>/dev/null || echo "0")
            
            echo "**Findings Count:**" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
            echo "- **Total:** ${TOTAL_FINDINGS}" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
            echo "- **Warning/Error:** ${WARNING_COUNT}" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
            echo "- **Info/Note:** ${INFO_COUNT}" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
            echo "" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
            
            if [ "$TOTAL_FINDINGS" -gt 0 ]; then
              echo "**Key Findings:**" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
              # Выводим первые 5 findings
              jq -r '.runs[0].results[0:5] | .[] | "### \(.ruleId)\n- **Level:** \(.level // .properties.metadata.severity // \"note\")\n- **File:** \(.locations[0].physicalLocation.artifactLocation.uri)\n- **Message:** \(.message.text)\n"' "$SEMG_SARIF" 2>/dev/null >> "EVIDENCE/P10/summary_${SHORT_SHA}.md" || echo "No detailed findings available" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
              
              if [ "$TOTAL_FINDINGS" -gt 5 ]; then
                echo "" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
                echo "... and $((TOTAL_FINDINGS - 5)) more findings." >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
              fi
            else
              echo "✅ No findings found." >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
            fi
          else
            echo "❌ Semgrep report not found or empty." >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
          fi
          
          echo "" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
          
          # Gitleaks analysis
          echo "## Gitleaks Secrets Detection" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
          echo "" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
          
          if [ -f "$GITL_JSON" ] && [ -s "$GITL_JSON" ]; then
            LEAK_COUNT=$(jq 'length' "$GITL_JSON" 2>/dev/null || echo "0")
            
            echo "**Secrets Found:** ${LEAK_COUNT}" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
            echo "" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
            
            if [ "$LEAK_COUNT" -gt 0 ]; then
              echo "**Detected Secrets:**" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
              jq -r '.[0:3] | .[] | "### \(.Description)\n- **File:** \(.File)\n- **Rule:** \(.RuleID)\n- **Secret:** \(.Secret | .[0:20])...\n- **Line:** \(.StartLine)\n"' "$GITL_JSON" 2>/dev/null >> "EVIDENCE/P10/summary_${SHORT_SHA}.md" || echo "Failed to parse findings" >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
            else
              echo "✅ No secrets detected." >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
            fi
          else
            echo "✅ No Gitleaks findings or report not generated." >> "EVIDENCE/P10/summary_${SHORT_SHA}.md"
          fi

      - name: Create README with current reports
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          
          echo "# P10 - SAST & Secrets Scan Reports" > "EVIDENCE/P10/README.md"
          echo "" >> "EVIDENCE/P10/README.md"
          echo "## Latest Scan (${SHORT_SHA})" >> "EVIDENCE/P10/README.md"
          echo "- **Semgrep SARIF:** [semgrep_latest.sarif](semgrep_latest.sarif) (from [semgrep_${SHORT_SHA}.sarif](semgrep_${SHORT_SHA}.sarif))" >> "EVIDENCE/P10/README.md"
          echo "- **Gitleaks JSON:** [gitleaks_latest.json](gitleaks_latest.json) (from [gitleaks_${SHORT_SHA}.json](gitleaks_${SHORT_SHA}.json))" >> "EVIDENCE/P10/README.md"
          echo "- **Scan Summary:** [summary_latest.md](summary_latest.md) (from [summary_${SHORT_SHA}.md](summary_${SHORT_SHA}.md))" >> "EVIDENCE/P10/README.md"
          echo "- **Scan Date:** $(date)" >> "EVIDENCE/P10/README.md"
          echo "" >> "EVIDENCE/P10/README.md"
          
          echo "## Available Reports:" >> "EVIDENCE/P10/README.md"
          echo "| File | Description | Commit |" >> "EVIDENCE/P10/README.md"
          echo "|------|-------------|--------|" >> "EVIDENCE/P10/README.md"
          
          # Только файлы текущего коммита
          echo "| [semgrep_${SHORT_SHA}.sarif](semgrep_${SHORT_SHA}.sarif) | Semgrep SAST report | ${SHORT_SHA} |" >> "EVIDENCE/P10/README.md"
          echo "| [gitleaks_${SHORT_SHA}.json](gitleaks_${SHORT_SHA}.json) | Gitleaks secrets report | ${SHORT_SHA} |" >> "EVIDENCE/P10/README.md"
          echo "| [summary_${SHORT_SHA}.md](summary_${SHORT_SHA}.md) | Scan summary | ${SHORT_SHA} |" >> "EVIDENCE/P10/README.md"
          echo "| [semgrep_latest.sarif](semgrep_latest.sarif) | Latest Semgrep report (symlink) | ${SHORT_SHA} |" >> "EVIDENCE/P10/README.md"
          echo "| [gitleaks_latest.json](gitleaks_latest.json) | Latest Gitleaks report (symlink) | ${SHORT_SHA} |" >> "EVIDENCE/P10/README.md"
          echo "| [summary_latest.md](summary_latest.md) | Latest summary (symlink) | ${SHORT_SHA} |" >> "EVIDENCE/P10/README.md"
          
          echo "" >> "EVIDENCE/P10/README.md"
          echo "## How to View Reports" >> "EVIDENCE/P10/README.md"
          echo "1. Click on the links above to view reports in GitHub" >> "EVIDENCE/P10/README.md"
          echo "2. For SARIF files, use GitHub Code Scanning or a SARIF viewer" >> "EVIDENCE/P10/README.md"
          echo "3. JSON reports can be viewed directly or parsed with jq" >> "EVIDENCE/P10/README.md"

      - name: Upload SAST evidence artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p10-sast-reports-${{ steps.commit.outputs.short_sha }}
          path: EVIDENCE/P10/
          retention-days: 30

      - name: Display scan summary and links
        if: always()
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          echo "=== P10 SAST & Secrets Scan Complete ==="
          echo "Commit: ${SHORT_SHA}"
          echo ""
          echo "Generated Reports in EVIDENCE/P10/:"
          echo ""
          ls -la EVIDENCE/P10/ || echo "No reports generated"
          echo ""
          echo "Raw GitHub URLs (copy to PR):"
          echo ""
          echo "### Semgrep SAST:"
          echo "- Latest: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/semgrep_latest.sarif"
          echo "- This commit: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/semgrep_${SHORT_SHA}.sarif"
          echo ""
          echo "### Gitleaks Secrets:"
          echo "- Latest: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/gitleaks_latest.json"
          echo "- This commit: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/gitleaks_${SHORT_SHA}.json"
          echo ""
          echo "### Scan Summary:"
          echo "- Latest: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/summary_latest.md"
          echo "- This commit: https://github.com/${{ github.repository }}/raw/${{ github.ref_name }}/EVIDENCE/P10/summary_${SHORT_SHA}.md"

      - name: Commit reports to repository
        if: always() && github.event_name == 'push'
        run: |
          SHORT_SHA="${{ steps.commit.outputs.short_sha }}"
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Проверяем, есть ли изменения для коммита
          CHANGES=false
          
          # Добавляем файлы с кодом коммита
          if [ -f "EVIDENCE/P10/semgrep_${SHORT_SHA}.sarif" ]; then
            git add "EVIDENCE/P10/semgrep_${SHORT_SHA}.sarif"
            CHANGES=true
          fi
          
          if [ -f "EVIDENCE/P10/gitleaks_${SHORT_SHA}.json" ]; then
            git add "EVIDENCE/P10/gitleaks_${SHORT_SHA}.json"
            CHANGES=true
          fi
          
          if [ -f "EVIDENCE/P10/summary_${SHORT_SHA}.md" ]; then
            git add "EVIDENCE/P10/summary_${SHORT_SHA}.md"
            CHANGES=true
          fi
          
          # Добавляем README
          if [ -f "EVIDENCE/P10/README.md" ]; then
            git add "EVIDENCE/P10/README.md" || true
            CHANGES=true
          fi
          
          # Добавляем симлинки latest
          if [ -f "EVIDENCE/P10/semgrep_${SHORT_SHA}.sarif" ]; then
            git add "EVIDENCE/P10/semgrep_latest.sarif" || true
            CHANGES=true
          fi
          
          if [ -f "EVIDENCE/P10/gitleaks_${SHORT_SHA}.json" ]; then
            git add "EVIDENCE/P10/gitleaks_latest.json" || true
            CHANGES=true
          fi
          
          if [ -f "EVIDENCE/P10/summary_${SHORT_SHA}.md" ]; then
            git add "EVIDENCE/P10/summary_latest.md" || true
            CHANGES=true
          fi
          
          if [ "$CHANGES" = true ]; then
            # Сначала пулим изменения чтобы быть в актуальном состоянии
            echo "Pulling latest changes..."
            git pull origin ${{ github.ref_name }} --no-rebase --ff-only || echo "Pull failed, continuing..."
            
            # Коммитим изменения
            git commit -m "P10: SAST & Secrets scan report for commit ${SHORT_SHA} [skip ci]

            Generated files:
            - semgrep_${SHORT_SHA}.sarif (SAST report)
            - gitleaks_${SHORT_SHA}.json (secrets scan)
            - summary_${SHORT_SHA}.md (analysis)

            Latest symlinks updated."
            
            # Пушим изменения
            echo "Pushing changes..."
            git push origin ${{ github.ref_name }}
            
            echo "✅ Reports committed and pushed successfully"
          else
            echo "⚠️ No changes to commit"
          fi